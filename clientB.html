<!DOCTYPE html>
<html>
<head>
    <title>WebRTC - Client B</title>
</head>
<body>
    <h2>Client B (Récepteur)!</h2>
    <button onclick="connectWebSocket()">Reconnecte</button>
    <video id="remoteVideo" autoplay playsinline style="width: 100%; height: auto;"></video>
    <script>
        const remoteVideo = document.getElementById('remoteVideo');
        const peerConnection = new RTCPeerConnection();
        let socket;

        function connectWebSocket() {
            socket = new WebSocket('wss://nameless-caverns-19262-2b731442c0a5.herokuapp.com'); // Remplacez par l'URL de votre serveur WebSocket

            socket.onopen = () => {
                console.log('Connecté au serveur WebSocket');
            };

            socket.onmessage = event => {
                if (event.data instanceof Blob) {
                    const reader = new FileReader();
                    reader.onload = function() {
                        try {
                            const message = JSON.parse(reader.result);
                            handleMessage(message);
                        } catch (error) {
                            console.error('Erreur lors du traitement du message:', error);
                        }
                    };
                    reader.readAsText(event.data);
                } else if (typeof event.data === 'string') {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        console.error('Erreur lors du traitement du message:', error);
                    }
                } else {
                    console.error('Données reçues non-JSON:', event.data);
                }
            };

            socket.onerror = error => {
                console.error('Erreur WebSocket:', error);
            };

            socket.onclose = event => {
                console.log(`Déconnexion du serveur WebSocket: Code ${event.code}, Raison: ${event.reason}`);
                setTimeout(connectWebSocket, 1000);
            };
        }

        function handleMessage(message) {
            console.log('Message reçu:', message);

            if (message.type === 'offer') {
                peerConnection.setRemoteDescription(new RTCSessionDescription(message.data))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        socket.send(JSON.stringify({ type: 'answer', data: peerConnection.localDescription }));
                    })
                    .catch(error => {
                        console.error('Erreur lors de la réponse:', error);
                    });
            } else if (message.type === 'candidate') {
                peerConnection.addIceCandidate(new RTCIceCandidate(message.data))
                    .catch(error => {
                        console.error('Erreur lors de l\'ajout du candidat ICE:', error);
                    });
            }
        }

        connectWebSocket();

        peerConnection.ontrack = event => {
            console.log('Track reçue:', event);
            console.log('Streams reçues:', event.streams);
            console.log('Streams reçues:', event.streams[0]);
            if (event.streams && event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
            } else {
                console.error('Aucun flux vidéo trouvé dans les données reçues.');
            }
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                socket.send(JSON.stringify({ type: 'candidate', data: event.candidate }));
            }
        };
    </script>
</body>
</html>
